<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>1 contre 1 local</title>
  </head>
  <body>
    <nav id="navigation">
      <p id="menuOpen">Menu</p>
      <button
        onclick="location.href = 'apprendre_a_jouer.html';"
        class="button_nav"
      >
        Apprendre à jouer
      </button>
      <button onclick="location.href = 'sandbox.html';" class="button_nav">
        Bac à sable
      </button>
      <button onclick="location.href = 'exercices.html';" class="button_nav">
        Exercices pratiques
      </button>
      <button onclick="location.href = 'versus.html';" class="button_nav">
        1 contre 1 local
      </button>
    </nav>
    <section>
      <div id="board1" style="width: 400px"></div>
      <button id="clear">Clear</button>
      <div style="display: inline-block; padding: 0 0 0 100px">
        <p>Blanc</p>
        <p id="white">10:00</p>
      </div>
      <div style="display: inline-block; padding: 0 0 0 0100px">
        <p>Noir</p>
        <p id="black">10:00</p>
      </div>
      <br />
      <button id="timer">Start Timer</button><br /><br />
      <div id="timeTurn"></div>
    </section>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"
      integrity="sha512-oprzqYFJfo4Bx/nNEcSI0xo7ggJrLc+qQ6hrS3zV/Jn0C4dsg4gu+FXW/Vm0jP9CrV7e5e6dcLUYkg3imjfjbw=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
      integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
      crossorigin="anonymous"
    ></script>
    <script>
      let board = null;
      let game = new Chess();
      let whiteSquareGrey = "#a9a9a9";
      let blackSquareGrey = "#696969";

      function removeGreySquares() {
        $("#board1 .square-55d63").css("background", "");
      }

      function greySquare(square) {
        var $square = $("#board1 .square-" + square);

        var background = whiteSquareGrey;
        if ($square.hasClass("black-3c85d")) {
          background = blackSquareGrey;
        }

        $square.css("background", background);
      }

      function onDragStart(source, piece) {
        if (game.game_over()) return false;

        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function onDrop(source, target) {
        removeGreySquares();

        var move = game.move({
          from: source,
          to: target,
          promotion: "q",
        });

        if (move === null) return "snapback";
      }

      function onMouseoverSquare(square, piece) {
        var moves = game.moves({
          square: square,
          verbose: true,
        });

        if (moves.length === 0) return;

        greySquare(square);

        for (var i = 0; i < moves.length; i++) {
          greySquare(moves[i].to);
        }
      }

      function onMouseoutSquare(square, piece) {
        removeGreySquares();
      }

      function onSnapEnd() {
        board.position(game.fen());
      }

      var config = {
        draggable: true,
        position: "start",
        onDragStart,
        onDrop,
        onMouseoutSquare,
        onMouseoverSquare,
        onSnapEnd,
      };
      board = Chessboard("board1", config);

      document.getElementById("clear").onclick = () => {
        window.location.reload();
      };

      let colors = {
        white: 600,
        black: 600,
      };

      let turn = 0;
      let start = false;
      let turnSeconds = 0;
      let turnMinutes = 0;
      const timerTurn = document.getElementById("timeTurn");
      let timerButton = document.getElementById("timer");
      let interval;
      function Turn(color) {
        if (start != false) {
          let numberFormat = ("0" + turnSeconds).slice(-2);
          let colorPrec;
          color === "black"
            ? (colorPrec = "blanc &emsp;")
            : (colorPrec = "noir &emsp;&ensp;&nbsp");
          timerTurn.insertAdjacentHTML(
            "beforeend",
            "<p class='turnFocus' style='margin: 0;'>tour " +
              turn +
              " - " +
              colorPrec +
              "   <span style='color:blue;'>" +
              turnMinutes +
              " : " +
              numberFormat +
              "</span></p>"
          );
          document
            .getElementsByClassName("turnFocus")
            [
              document.getElementsByClassName("turnFocus").length - 1
            ].scrollIntoView({ behavior: "smooth" });
        } else {
          start = true;
        }
        interval = setInterval(() => {
          colors[color] -= 1;
          turnSeconds += 1;
          if (turnSeconds === 60) {
            turnSeconds = 0;
            turnMinutes += 1;
          }
          let minutes = Math.floor(colors[color] / 60);
          let seconds = colors[color] % 60;
          document.getElementById(color).innerHTML = minutes + ":" + seconds;
          if (colors[color] === 0) {
            clearInterval(interval);
            timerButton.remove();
            alert("Plus de temps !");
          }
        }, 1000);
        if (color === "white") turn++;
        turnSeconds = 0;
        turnMinutes = 0;
      }

      timer.onclick = () => {
        switch (timerButton.innerHTML) {
          case "Start Timer":
            Turn("white");
            timerButton.innerHTML = "Tour des noirs";
            break;
          case "Tour des noirs":
            clearInterval(interval);
            Turn("black");
            timerButton.innerHTML = "Tour des blancs";
            break;
          case "Tour des blancs":
            clearInterval(interval);
            Turn("white");
            timerButton.innerHTML = "Tour des noirs";
            break;
        }
      };
    </script>
  </body>
</html>
